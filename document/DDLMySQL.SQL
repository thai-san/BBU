DROP TABLE IF EXISTS attachments;
DROP TABLE IF EXISTS files;
DROP TABLE IF EXISTS books;
DROP TABLE IF EXISTS sessions;
DROP TABLE IF EXISTS visitors;
DROP TABLE IF EXISTS students;
DROP TABLE IF EXISTS posts;
DROP TABLE IF EXISTS categories;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS groups;

CREATE TABLE groups (
	group_id	INT NOT NULL AUTO_INCREMENT,
	group_name	VARCHAR(40) NOT NULL,
	group_create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (group_id)
) DEFAULT CHARACTER SET utf8;

CREATE TABLE users (
	user_id		INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	user_name	VARCHAR(40) NOT NULL UNIQUE KEY,
	password	VARCHAR(40) NOT NULL,
	group_id	INT NOT NULL,
	is_enable	TINYINT(1) DEFAULT 1 NOT NULL,
	is_admin	TINYINT(1) DEFAULT 0 NOT NULL,
	user_create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	FOREIGN KEY (group_id) REFERENCES groups (group_id) ON DELETE RESTRICT ON UPDATE CASCADE
) DEFAULT CHARACTER SET utf8;

CREATE TABLE students (
	student_id		VARCHAR(40) NOT NULL PRIMARY KEY,
	student_name	VARCHAR(40) NOT NULL,
	email			VARCHAR(100),
	password		VARCHAR(40) NOT NULL,
	last_activity 	TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	is_enable		TINYINT(1) NOT NULL DEFAULT 1
) DEFAULT CHARACTER SET utf8;

CREATE TABLE categories (
	category_id		INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	category_name	VARCHAR(40) NOT NULL,
	category_create_date TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) DEFAULT CHARACTER SET utf8;

CREATE TABLE posts (
	post_id			INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	post_title		VARCHAR(255) NOT NULL,
	post_type 		ENUM('PDF','IMAGE','TEXT') NOT NULL,
	post_description TEXT,
	post_date		TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	owner 			INT NOT NULL,
	category_id		INT NULL,
	expire_date		DATE NOT NULL,
	is_enable		TINYINT(1) NOT NULL DEFAULT 1,
	FOREIGN KEY (owner) REFERENCES users (user_id) ON DELETE RESTRICT ON UPDATE CASCADE,
	FOREIGN KEY (category_id) REFERENCES categories (category_id) ON DELETE SET NULL ON UPDATE CASCADE
) DEFAULT CHARACTER SET utf8;

CREATE TABLE books (
	book_id				INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	book_title			VARCHAR(100) NOT NULL,
	owner 				INT NOT NULL,
	upload_date 		TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	total_download		INT NOT NULL DEFAULT 0,
	FOREIGN KEY (owner) REFERENCES users (user_id) ON DELETE RESTRICT ON UPDATE CASCADE
) DEFAULT CHARACTER SET utf8;

CREATE TABLE visitors (
	visiter_id	INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
	ip_address	VARCHAR(45) DEFAULT '0' NOT NULL,
	student_id	VARCHAR(40) NULL,
	post_id	INT NOT NULL,
	visite_date	TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	UNIQUE KEY (ip_address, post_id),
	FOREIGN KEY (student_id) REFERENCES students (student_id) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (post_id) REFERENCES posts (post_id) ON DELETE CASCADE ON UPDATE CASCADE
) DEFAULT CHARACTER SET utf8;

CREATE TABLE sessions (
	session_id VARCHAR(40) DEFAULT '0' NOT NULL PRIMARY KEY,
	ip_address VARCHAR(45) DEFAULT '0' NOT NULL,
	user_agent VARCHAR(120) NOT NULL,
	last_activity INT(10) unsigned DEFAULT 0 NOT NULL,
	user_data TEXT NOT NULL,
	KEY `last_activity_idx` (`last_activity`)
) DEFAULT CHARACTER SET utf8;

CREATE TABLE files (
	file_id INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY,
	file_name VARCHAR(50) NOT NULL,
	file_type VARCHAR(50) NOT NULL,
	file_path VARCHAR(255) NOT NULL,
	full_path VARCHAR(255) NOT NULL,
	raw_name VARCHAR(50) DEFAULT NULL,
	orig_name VARCHAR(255) DEFAULT NULL,
	client_name VARCHAR(255) DEFAULT NULL,
	file_ext VARCHAR(20) DEFAULT NULL,
	file_size INT DEFAULT NULL,
	is_image TINYINT(1) DEFAULT NULL,
	image_width INT DEFAULT NULL,
	image_height INT DEFAULT NULL,
	image_type VARCHAR(20) DEFAULT NULL,
	image_size_str VARCHAR(100) DEFAULT NULL,
	file_owner INT(11) NOT NULL,
	file_upload_date timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) DEFAULT CHARACTER SET utf8;

CREATE TABLE attachments (
	attachment_id INT NOT NULL AUTO_INCREMENT,
	file_id INT NOT NULL,
	post_id INT NOT NULL,
	PRIMARY KEY (attachment_id, file_id, post_id),
	FOREIGN KEY (file_id) REFERENCES files (file_id) ON DELETE CASCADE ON UPDATE CASCADE,
	FOREIGN KEY (post_id) REFERENCES posts (post_id) ON DELETE CASCADE ON UPDATE CASCADE
) DEFAULT CHARACTER SET utf8;

-- Create Trigger
CREATE TRIGGER
	post_expire_date_trigger
BEFORE INSERT ON
	posts
FOR EACH ROW SET
	NEW.expire_date = IFNULL(NEW.expire_date, TIMESTAMPADD(DAY, 30, NOW()));

-- Insert Test Data
-- INSERT INTO groups (group_name) VALUES ('MIS');
-- INSERT INTO users (user_name, password, is_admin, group_id) VALUES ('admin', '202cb962ac59075b964b07152d234b70', 1, 1);
-- INSERT INTO categories (category_name) VALUES ('Uncategory');